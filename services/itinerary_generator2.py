import logging
import json
from typing import List, Dict
from datetime import timedelta
from google import genai
from google.genai import types
from config import settings
from models.schemas2 import ItineraryRequest2, ItineraryResponse2, PlaceWithTag, PlaceTag

logger = logging.getLogger(__name__)


class ItineraryGeneratorService2:
    """V2 ì¼ì • ìƒì„± ì„œë¹„ìŠ¤ (Gemini ì¤‘ì‹¬)"""

    def __init__(self):
        """Gemini í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”"""
        self.client = genai.Client(api_key=settings.google_api_key)
        self.model_name = "gemini-2.5-pro"
        logger.info("ItineraryGeneratorService2 initialized with gemini-2.5-pro and Google Maps grounding")

    def _create_prompt_v2(
        self,
        request: ItineraryRequest2,
    ) -> str:
        """
        Gemini V2 í”„ë¡¬í”„íŠ¸ ìƒì„±

        Args:
            request: ì¼ì • ìƒì„± ìš”ì²­

        Returns:
            ì™„ì„±ëœ í”„ë¡¬í”„íŠ¸ ë¬¸ìì—´
        """
        # ë‚ ì§œë³„ ìš”ì¼ ê³„ì‚°
        weekdays_kr = ["ì›”ìš”ì¼", "í™”ìš”ì¼", "ìˆ˜ìš”ì¼", "ëª©ìš”ì¼", "ê¸ˆìš”ì¼", "í† ìš”ì¼", "ì¼ìš”ì¼"]
        date_info = []
        for day_num in range(request.days):
            current_date = request.start_date + timedelta(days=day_num)
            weekday = weekdays_kr[current_date.weekday()]
            date_info.append(f"Day {day_num + 1}: {current_date.strftime('%Y-%m-%d')} ({weekday})")

        # ì±„íŒ… ë‚´ìš© í¬ë§·íŒ…
        chat_text = "\n".join([f"- {msg}" for msg in request.chat])

        # ê·œì¹™ í¬ë§·íŒ…
        rule_text = ""
        if request.rule:
            rule_text = "\n".join([f"- {r}" for r in request.rule])
        else:
            rule_text = "ì—†ìŒ"

        # í•„ìˆ˜ ë°©ë¬¸ ì¥ì†Œ í¬ë§·íŒ…
        must_visit_text = ""
        if request.must_visit:
            must_visit_text = ", ".join(request.must_visit)
        else:
            must_visit_text = "ì—†ìŒ"

        # ìˆ™ì†Œ ì •ë³´ ì¶”ì¶œ: placesì—ì„œ place_tagê°€ HOMEì¸ ì¥ì†Œ ì°¾ê¸°
        home_places = [place for place in request.places if place.place_tag == PlaceTag.HOME]
        if home_places:
            # ì‚¬ìš©ìê°€ ì§€ì •í•œ ìˆ™ì†Œê°€ ìˆëŠ” ê²½ìš°
            accommodation_text = home_places[0].place_name
            if len(home_places) > 1:
                # ì—¬ëŸ¬ ìˆ™ì†Œê°€ ìˆëŠ” ê²½ìš° ëª¨ë‘ í‘œì‹œ
                accommodation_text = ", ".join([place.place_name for place in home_places])
        else:
            # ìˆ™ì†Œê°€ ì—†ëŠ” ê²½ìš° Geminiì—ê²Œ ì¶”ì²œ ìš”ì²­
            accommodation_text = "ì—†ìŒ (ì¶”ì²œ í•„ìš”)"

        # ì¥ì†Œ ëª©ë¡ í¬ë§·íŒ… (place_nameê³¼ place_tag í¬í•¨)
        places_text = "\n".join([f"- {place.place_name} ({place.place_tag.value})" for place in request.places])

        # í”„ë¡¬í”„íŠ¸ êµ¬ì„±
        prompt = f"""## ë‹¹ì‹ ì˜ ì—­í• 
ë‹¹ì‹ ì€ ì—¬í–‰ ì¼ì • ìƒì„± ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì‚¬ìš©ìê°€ ë‚˜ëˆˆ ì±„íŒ… ë‚´ìš©ì„ ë¶„ì„í•˜ê³ , ì œê³µëœ ì¥ì†Œ ëª©ë¡ê³¼ í•¨ê»˜ ìµœì ì˜ ì—¬í–‰ ì¼ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.

## ì…ë ¥ ë°ì´í„°

### ì—¬í–‰ êµ­ê°€/ë„ì‹œ
{request.country}

### ì—¬í–‰ ì¸ì›
{request.members}ëª…

### ì—¬í–‰ ê¸°ê°„
{chr(10).join(date_info)}
ì´ {request.days}ì¼

### ê³ ë ¤ ì¤‘ì¸ ì¥ì†Œ ëª©ë¡ (places)
ê° ì¥ì†Œì—ëŠ” ì‚¬ìš©ìê°€ ì§€ì •í•œ place_tagê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
{places_text}

### ì‚¬ìš©ì ëŒ€í™” ë‚´ìš© (chat)
{chat_text}

### ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•  ê·œì¹™ (rule)
{rule_text}

### í•„ìˆ˜ ë°©ë¬¸ ì¥ì†Œ (must_visit)
{must_visit_text}

### ìˆ™ì†Œ (accommodation)
{accommodation_text}

## ì¼ì • ìƒì„± ìš°ì„ ìˆœìœ„

### ğŸ”´ Priority 1: ì‚¬ìš©ì ìš”ì²­ì‚¬í•­ (í•„ìˆ˜)
A. **must_visit ì¥ì†Œ**: 100% í¬í•¨ í•„ìˆ˜
B. **rules ì¤€ìˆ˜**: 100% ì¤€ìˆ˜ í•„ìˆ˜
C. **days/start_date**: ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨
D. **chat ì„ í˜¸ë„ ë°˜ì˜**: places ëª©ë¡ì—ì„œ ìš°ì„  ì„ íƒ, ì‚¬ìš©ì ì˜ë„ ìµœëŒ€í•œ ë°˜ì˜

### ğŸŸ  Priority 2: ìš´ì˜ì‹œê°„ & ì´ë™ì‹œê°„ (ìµœëŒ€í•œ ê¶Œì¥)
- ëª¨ë“  ë°©ë¬¸ì€ ìš´ì˜ì‹œê°„ ë‚´ì—ë§Œ ê°€ëŠ¥
- íœ´ë¬´ì¼ ë°©ë¬¸ ê¸ˆì§€
- ì´ë™ì‹œê°„ ê³ ë ¤ í•„ìˆ˜ (Google Maps Grounding Tool í™œìš©)
- arrival/departure ì‹œê°„ ì¼ê´€ì„± ìœ ì§€

### ğŸŸ¡ Priority 3: ìµœì í™” (ê¶Œì¥)
- ì´ë™ì‹œê°„ ìµœì†Œí™”
- ì‚¬ìš©ì ë§Œì¡±ë„ ìµœëŒ€í™” (chat ë‚´ìš© ê¸°ë°˜)
- ì²´ë¥˜ì‹œê°„ ì ì ˆì„±
- ì˜ˆì‚° í•©ë¦¬ì„±

---

## ì‘ì—… ì§€ì‹œì‚¬í•­

### 1. ì±„íŒ… ë¶„ì„ ë° ì´ë™ ìˆ˜ë‹¨ ì¶”ë¡ 
- ì‚¬ìš©ìë“¤ì˜ ëŒ€í™”ë¥¼ ì½ê³  ì—¬í–‰ ì˜ë„, ì„ í˜¸ë„, íŒ¨í„´ì„ íŒŒì•…í•˜ì„¸ìš”
- ëŒ€í™”ì—ì„œ ì–¸ê¸‰ëœ íŠ¹ì • ìš”êµ¬ì‚¬í•­ì´ë‚˜ ì„ í˜¸ì‚¬í•­ì„ ë°˜ì˜í•˜ì„¸ìš”
- **ì´ë™ ìˆ˜ë‹¨ ì¶”ë¡ **: ì‚¬ìš©ì ëŒ€í™”ì—ì„œ ì´ë™ ìˆ˜ë‹¨ì„ íŒŒì•…í•˜ì„¸ìš”
  - ëŒ€í™”ì—ì„œ ëª…ì‹œì ìœ¼ë¡œ ì–¸ê¸‰ëœ ê²½ìš°:
    - "ë Œí„°ì¹´", "ì°¨ ë¹Œë ¤ì„œ", "ìë™ì°¨" â†’ **DRIVE** (ìë™ì°¨)
    - "ì§€í•˜ì² ", "ë²„ìŠ¤", "ëŒ€ì¤‘êµí†µ" â†’ **TRANSIT** (ëŒ€ì¤‘êµí†µ)
    - "ê±¸ì–´ì„œ", "ë„ë³´", "ì‚°ì±…" â†’ **WALK** (ë„ë³´)
    - "ìì „ê±°" â†’ **BICYCLE** (ìì „ê±°)
  - **ëŒ€í™”ì— ì´ë™ ìˆ˜ë‹¨ ì–¸ê¸‰ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ TRANSIT (ëŒ€ì¤‘êµí†µ)ì„ ì‚¬ìš©í•˜ì„¸ìš”**
  - ì¶”ë¡ í•œ ì´ë™ ìˆ˜ë‹¨ì„ travel_time ê³„ì‚°ì— ë°˜ì˜í•˜ì„¸ìš”

### 2. Google Maps ë°ì´í„° í™œìš© (í•„ìˆ˜)
- **ì¤‘ìš”**: Google Maps ë„êµ¬ë¥¼ í™œìš©í•˜ì—¬ ëª¨ë“  ì¥ì†Œì˜ ì •ë³´ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¡°íšŒí•˜ì„¸ìš”
- **ì¡°íšŒ í•­ëª©**:
  - ì •í™•í•œ ì¢Œí‘œ (latitude, longitude): ì†Œìˆ˜ì  6ìë¦¬ê¹Œì§€ ì •í™•í•œ ì¢Œí‘œ ì‚¬ìš©
  - ìš´ì˜ì‹œê°„ (opening hours): ê° ì¥ì†Œì˜ ì˜ì—…/ê°œì¥ ì‹œê°„ í™•ì¸
  - ì´ë™ì‹œê°„ (travel time): ì‹¤ì œ ë„ë¡œ/ëŒ€ì¤‘êµí†µ ê¸°ë°˜ ì´ë™ì‹œê°„ ê³„ì‚°
  - ìƒì„¸ ì£¼ì†Œ (address): name_address í•„ë“œì— ì‚¬ìš©í•  ì •í™•í•œ ì£¼ì†Œ
- **ì ìš© ë°©ë²•**:
  - ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì¥ì†Œëª… â†’ Google Mapsë¡œ ê²€ìƒ‰í•˜ì—¬ ì •í™•í•œ ì •ë³´ ì¡°íšŒ
  - Geminiê°€ ì¶”ì²œí•˜ëŠ” ìƒˆë¡œìš´ ì¥ì†Œ â†’ Google Mapsë¡œ ê²€ìƒ‰í•˜ì—¬ ì‹¤ì¡´ ì—¬ë¶€ ë° ì •ë³´ í™•ì¸
  - ìš´ì˜ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ë°©ë¬¸ ì‹œê°„(arrival/departure) ì¡°ì •
  - ì‹¤ì œ ì´ë™ì‹œê°„ì„ ê¸°ë°˜ìœ¼ë¡œ travel_time ê³„ì‚° (êµí†µ ìƒí™© ê³ ë ¤)

### 3. ğŸ”´ í•„ìˆ˜ ë°©ë¬¸ ì¥ì†Œ í¬í•¨ (Priority 1-A) - ì ˆëŒ€ ê·œì¹™

**í•„ìˆ˜ ë°©ë¬¸ ì¥ì†Œ (must_visit) ê°•ì œ ì ìš©**:
1. **100% í¬í•¨ ì˜ë¬´**: must_visitì— ëª…ì‹œëœ ëª¨ë“  ì¥ì†ŒëŠ” ë°˜ë“œì‹œ ì¼ì •ì— í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤
2. **ìš°ì„ ìˆœìœ„ ìµœìƒìœ„**: ì¼ì •ì´ ë¶€ì¡±í•˜ë©´ ë‹¤ë¥¸ ì¶”ì²œ ì¥ì†Œë¥¼ ì œê±°í•˜ë”ë¼ë„ must_visitëŠ” ë°˜ë“œì‹œ ìœ ì§€í•˜ì„¸ìš”
3. **ë‚ ì§œ ì¬ì¡°ì • í—ˆìš©**: must_visit ì¥ì†Œì˜ ìš´ì˜ì‹œê°„ì´ ë§ì§€ ì•Šìœ¼ë©´ ë‹¤ë¥¸ ë‚ ì§œë¡œ ì´ë™í•˜ì„¸ìš”
4. **ì ˆëŒ€ ìƒëµ ê¸ˆì§€**: ì–´ë–¤ ìƒí™©ì—ì„œë„ must_visit ì¥ì†Œë¥¼ ìƒëµí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤
5. **ê²€ì¦ ë°©ë²•**: ì¼ì • ìƒì„± í›„ ëª¨ë“  must_visit ì¥ì†Œê°€ í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”
   - ì²´í¬ë¦¬ìŠ¤íŠ¸: must_visitì˜ ê° ì¥ì†Œëª…ì´ itineraryì˜ ì–´ëŠ dayì—ë“  ì¡´ì¬í•´ì•¼ í•¨

**ì¥ì†Œ ì„ íƒ ìš°ì„ ìˆœìœ„ (Priority 1-D)**:
- ìœ„ì˜ "ê³ ë ¤ ì¤‘ì¸ ì¥ì†Œ ëª©ë¡ (places)"ì—ì„œ ì ì ˆí•œ ì¥ì†Œë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì„ íƒí•˜ì„¸ìš”
- **ì¤‘ìš”**: placesì— ì í•©í•œ ì¥ì†Œê°€ ì—†ê±°ë‚˜ ë¶€ì¡±í•˜ë‹¤ë©´ ì§ì ‘ ì¥ì†Œë¥¼ ì°¾ì•„ ì¶”ì²œí•˜ì„¸ìš”
  - ì˜ˆ: ì±„íŒ…ì— "ë§›ìˆëŠ” ë¼ë©˜ ê°€ê²Œ ê°€ê³  ì‹¶ë‹¤"ë¼ê³  í–ˆëŠ”ë° placesì— ë¼ë©˜ì§‘ì´ ì—†ìœ¼ë©´
    â†’ Google Mapsë¡œ í•´ë‹¹ ì§€ì—­ì˜ ìœ ëª…í•œ ë¼ë©˜ ê°€ê²Œë¥¼ ì°¾ì•„ì„œ ì¼ì •ì— í¬í•¨ (ì¥ì†Œëª…ê³¼ ì¢Œí‘œ í¬í•¨)
  - ì˜ˆ: ì±„íŒ…ì— "ì¹´í˜ì—ì„œ ì—¬ìœ ë¡­ê²Œ"ë¼ê³  í–ˆëŠ”ë° placesì— ì¹´í˜ê°€ ì—†ìœ¼ë©´
    â†’ Google Mapsë¡œ ì ì ˆí•œ ì¹´í˜ë¥¼ ì¶”ì²œí•˜ì„¸ìš”
- ì¥ì†Œì˜ íŠ¹ì„±, ì†Œìš”ì‹œê°„, ì§€ë¦¬ì  ìœ„ì¹˜ë¥¼ ê³ ë ¤í•˜ì—¬ í•©ë¦¬ì ìœ¼ë¡œ ë°°ì¹˜í•˜ì„¸ìš”
- **place_tag í™œìš©**:
  - placesì— í¬í•¨ëœ ì¥ì†Œë¥¼ ì¼ì •ì— ì‚¬ìš©í•  ë•ŒëŠ” í•´ë‹¹ place_tagë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”
  - Geminiê°€ ì¥ì†Œ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆì„ ë•Œ place_tagë¥¼ ì°¸ê³ í•˜ì„¸ìš”
  - ì˜ˆ: ì¥ì†Œëª…ë§Œ ìˆê³  ìƒì„¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ place_tagë¡œ ì¥ì†Œ ìœ í˜•ì„ íŒŒì•…
  - Geminiê°€ ìƒˆë¡œ ì¶”ì²œí•˜ëŠ” ì¥ì†ŒëŠ” ê°€ì¥ ì ì ˆí•œ place_tagë¥¼ ì„ íƒí•˜ì„¸ìš”

### 4. ìˆ™ì†Œ ì¶”ì²œ ë° ê´€ë¦¬
- **ìˆ™ì†Œ ê²°ì • ë°©ë²•**:
  - **ìš°ì„ ìˆœìœ„ 1**: places í•„ë“œì— place_tagê°€ "HOME"ì¸ ì¥ì†Œê°€ ìˆë‹¤ë©´, ê·¸ê²ƒì´ ì‚¬ìš©ìê°€ ì§€ì •í•œ ìˆ™ì†Œì…ë‹ˆë‹¤
    - ì´ ê²½ìš° accommodation í•„ë“œì— í•´ë‹¹ ìˆ™ì†Œëª…ì´ í‘œì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤
    - í•´ë‹¹ ìˆ™ì†Œë¥¼ ì‚¬ìš©í•˜ê³ , Geminiê°€ ì •í™•í•œ ì¢Œí‘œì™€ ì£¼ì†Œë¥¼ ì¶”ë¡ í•˜ì„¸ìš”
  - **ìš°ì„ ìˆœìœ„ 2**: accommodationì´ "ì—†ìŒ (ì¶”ì²œ í•„ìš”)"ë¡œ í‘œì‹œë˜ì–´ ìˆë‹¤ë©´ ìˆ™ì†Œ ì¶”ì²œì´ í•„ìš”í•©ë‹ˆë‹¤:
    - **ì‚¬ìš©ì ëŒ€í™”(chat)ë¥¼ ë¶„ì„í•˜ì—¬ ìˆ™ì†Œ ê´€ë ¨ ì„ í˜¸ì‚¬í•­ì„ ë°˜ì˜í•˜ì„¸ìš”**
      - ì˜ˆ: "ë‚œë°” ìª½ì´ ì¢‹ì„ê¹Œ?", "í˜¸í…”", "ê²ŒìŠ¤íŠ¸í•˜ìš°ìŠ¤", "ì—­ ê·¼ì²˜", "ì €ë ´í•œ", "ê¹¨ë—í•œ" ë“±
    - **ë¹„ìš© ê³ ë ¤**: ëŒ€í™”ì—ì„œ ì–¸ê¸‰ëœ ì˜ˆì‚°ì´ë‚˜ ê°€ê²© ë¯¼ê°ë„ë¥¼ íŒŒì•…í•˜ì„¸ìš”
    - **ì‚¬ìš©ì ì·¨í–¥ ê³ ë ¤**: ëŒ€í™” í†¤ê³¼ ë‚´ìš©ì—ì„œ ì—¬í–‰ ìŠ¤íƒ€ì¼ì„ íŒŒì•…í•˜ì„¸ìš” (ëŸ­ì…”ë¦¬/ê°€ì„±ë¹„/ë°°ë‚­ì—¬í–‰ ë“±)
    - **ì ‘ê·¼ì„±ê³¼ ë™ì„  íš¨ìœ¨ì„±**ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•˜ì„¸ìš”:
      - ê´€ê´‘ì§€ë“¤ì˜ ì¤‘ì‹¬ì— ìœ„ì¹˜í•˜ê±°ë‚˜ ëŒ€ì¤‘êµí†µ ì ‘ê·¼ì´ ì¢‹ì€ ìˆ™ì†Œ
      - ì£¼ìš” ê´€ê´‘ì§€ê¹Œì§€ì˜ í‰ê·  ì´ë™ì‹œê°„ì´ ì§§ì€ ìœ„ì¹˜
      - ì´ë™ ìˆ˜ë‹¨(travel_mode)ì„ ê³ ë ¤í•œ ìµœì  ìœ„ì¹˜ ì„ íƒ
    - ìœ„ ëª¨ë“  ìš”ì†Œë¥¼ ì¢…í•©í•˜ì—¬ ê°€ì¥ ì í•©í•œ ìˆ™ì†Œë¥¼ ì¶”ì²œí•˜ì„¸ìš”

### 5. ìˆ™ì†Œ ì™•ë³µ ì¼ì • êµ¬ì„±
- **ê¸°ë³¸ ì›ì¹™**: ì¼ë°˜ì ì¸ ìƒí™©ì—ì„œ í•˜ë£¨ ì¼ì •ì˜ ì‹œì‘ê³¼ ëì€ ìˆ™ì†Œì—¬ì•¼ í•©ë‹ˆë‹¤
  - êµ¬ì¡°: **ìˆ™ì†Œ (ì¶œë°œ) â†’ ê´€ê´‘ì§€1 â†’ ê´€ê´‘ì§€2 â†’ ... â†’ ìˆ™ì†Œ (ê·€í™˜)**
  - ì²« visitì€ ìˆ™ì†Œ ì¶œë°œ, ë§ˆì§€ë§‰ visitì€ ìˆ™ì†Œ ê·€í™˜ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”
  - ìˆ™ì†Œ ì¶œë°œ ì‹œ visit_timeì€ ì²« ê´€ê´‘ì§€ ë°©ë¬¸ì— ì ì ˆí•œ ì‹œê°„ìœ¼ë¡œ ì„¤ì • (ì˜ˆ: ì²« ê´€ê´‘ì§€ê°€ 10ì‹œ ê°œì¥ì´ë©´ 09:30 ì¶œë°œ)
  - ìˆ™ì†Œ ê·€í™˜ ì‹œ visit_timeì€ ë§ˆì§€ë§‰ ê´€ê´‘ì§€ ë°©ë¬¸ í›„ ì´ë™ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì„¤ì •
- **í•˜ë£¨ ì¼ì • ê¸¸ì´**: ì¼ë°˜ì ìœ¼ë¡œ 10-12ì‹œê°„ ì •ë„ê°€ ì ì ˆí•©ë‹ˆë‹¤
- **ì˜ˆì™¸ ì²˜ë¦¬** (ìš°ì„ ìˆœìœ„ê°€ ë†’ìŒ):
  - ì‚¬ìš©ì ëŒ€í™”ë‚˜ ê·œì¹™(rule)ì— ìˆ™ì†Œ ì™•ë³µê³¼ ë‹¤ë¥¸ íŒ¨í„´ì´ ëª…ì‹œë˜ì–´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ë”°ë¥´ì„¸ìš”
  - ì˜ˆ: "ë§ˆì§€ë§‰ë‚  ê³µí•­ìœ¼ë¡œ ì´ë™" â†’ ë§ˆì§€ë§‰ë‚ ì€ "ìˆ™ì†Œ â†’ ê´€ê´‘ì§€ â†’ ê³µí•­"ìœ¼ë¡œ êµ¬ì„±
  - ì˜ˆ: "ì²«ë‚  ê³µí•­ì—ì„œ ì¶œë°œ" â†’ ì²«ë‚ ì€ "ê³µí•­ â†’ ê´€ê´‘ì§€ â†’ ìˆ™ì†Œ"ë¡œ êµ¬ì„±
  - ê·œì¹™ì´ ìˆ™ì†Œ ì™•ë³µê³¼ ì¶©ëŒí•˜ë©´ **ê·œì¹™ì„ ìš°ì„ **í•˜ë˜, ê°€ëŠ¥í•œ ê²½ìš° ìˆ™ì†Œ ì™•ë³µì„ ìœ ì§€í•˜ì„¸ìš”

### 6. ì´ë™ì‹œê°„ ê³„ì‚° (Grounding Tool í™œìš©)

**í•„ìˆ˜ ì‚¬í•­**:
1. Google Maps Grounding Toolì„ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ ì´ë™ì‹œê°„ì„ ê³„ì‚°í•˜ì„¸ìš”
2. `travel_time` í•„ë“œì—ëŠ” ì‹¤ì œ ê³„ì‚°ëœ ì´ë™ì‹œê°„(ë¶„)ì„ ì…ë ¥í•˜ì„¸ìš”
3. êµí†µìˆ˜ë‹¨ì„ ê³ ë ¤í•˜ì„¸ìš” (TRANSIT/DRIVE/WALK ë“±)
4. ì´ë™ì‹œê°„ì€ arrival/departure ì‹œê°„ ê³„ì‚°ì— ë°˜ì˜í•˜ì„¸ìš”
5. ì²« ë²ˆì§¸ ë°©ë¬¸ì˜ travel_timeì€ 0ì…ë‹ˆë‹¤
6. ë§ˆì§€ë§‰ ë°©ë¬¸ì˜ travel_timeë„ 0ì…ë‹ˆë‹¤

**ê³„ì‚° ê³µì‹**:
```
next_place.arrival = current_place.departure + travel_time
```

**êµí†µìˆ˜ë‹¨ ì„ íƒ (ì„¹ì…˜ 1ì—ì„œ ì¶”ë¡ )**:
- **DRIVE**: ìë™ì°¨ ê²½ë¡œ ê¸°ë°˜ ì´ë™ì‹œê°„
- **TRANSIT**: ëŒ€ì¤‘êµí†µ ê²½ë¡œ ê¸°ë°˜ ì´ë™ì‹œê°„ (í™˜ìŠ¹ í¬í•¨) - **ê¸°ë³¸ê°’**
- **WALK**: ë„ë³´ ê²½ë¡œ ê¸°ë°˜ ì´ë™ì‹œê°„
- **BICYCLE**: ìì „ê±° ê²½ë¡œ ê¸°ë°˜ ì´ë™ì‹œê°„

**ê²€ì¦**:
- ê° ì—°ì†ëœ ë°©ë¬¸ ì‚¬ì´: `visit[i+1].arrival = visit[i].departure + visit[i].travel_time`
- ì‹¤ì‹œê°„ êµí†µ ìƒí™©, ëŒ€ì¤‘êµí†µ ë°°ì°¨ ê°„ê²©ì„ ê³ ë ¤í•œ í˜„ì‹¤ì ì¸ ì´ë™ì‹œê°„ì„ ë°˜ì˜í•˜ì„¸ìš”

### 7. ğŸ”´ ì¼ì • ê¸°ê°„ ì¤€ìˆ˜ (Priority 1-C)
ì—¬í–‰ ê¸°ê°„ ì •ë³´ëŠ” ìƒë‹¨ì˜ "ì—¬í–‰ ê¸°ê°„" ì„¹ì…˜ì— ëª…ì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤.

**ê·œì¹™**:
1. ì •í™•íˆ ìš”ì²­ëœ ì¼ìˆ˜ë§Œí¼ì˜ day í•­ëª©ì„ ìƒì„±í•˜ì„¸ìš”
2. ê° dayì˜ ë‚ ì§œëŠ” start_dateë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€í•´ì•¼ í•©ë‹ˆë‹¤
3. í•˜ë£¨ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ë¹¼ì§€ ë§ˆì„¸ìš”
4. day í•„ë“œëŠ” 1ë¶€í„° ì‹œì‘í•˜ì—¬ ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€í•©ë‹ˆë‹¤ (1, 2, 3, ...)

**ì˜ˆì‹œ**:
- ì—¬í–‰ ê¸°ê°„ì´ 3ì¼ì´ê³  start_dateê°€ 2025-10-15ì´ë©´
  - Day 1: 2025-10-15 (ìˆ˜ìš”ì¼)
  - Day 2: 2025-10-16 (ëª©ìš”ì¼)
  - Day 3: 2025-10-17 (ê¸ˆìš”ì¼)
- itinerary ë°°ì—´ì—ëŠ” ì •í™•íˆ 3ê°œì˜ day ê°ì²´ê°€ ìˆì–´ì•¼ í•¨

### 8. ğŸ”´ ì‚¬ìš©ì ê·œì¹™ ì¤€ìˆ˜ (Priority 1-B) - ì ˆëŒ€ ê·œì¹™

**ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•  ê·œì¹™ (rule) ê°•ì œ ì ìš©**:
1. **100% ë°˜ì˜ ì˜ë¬´**: ruleì— ëª…ì‹œëœ ëª¨ë“  í•­ëª©ì€ ë°˜ë“œì‹œ ì¼ì •ì— ì •í™•íˆ ë°˜ì˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤
2. **ìš°ì„ ìˆœìœ„**: ê·œì¹™(rule) > ìˆ™ì†Œ ì™•ë³µ > ê¸°ë³¸ íŒ¨í„´
3. **í•´ì„ ë¶ˆê°€ëŠ¥í•œ ê·œì¹™**: ê·œì¹™ì´ ëª¨í˜¸í•˜ë©´ ì‚¬ìš©ìì˜ ì˜ë„ë¥¼ ìµœëŒ€í•œ ì¶”ë¡ í•˜ì—¬ ì ìš©í•˜ì„¸ìš”

**ê·œì¹™ í•´ì„ ë° ì ìš© ë°©ë²•**:
- **ì‹œê°„ ì œì•½ ê·œì¹™**:
  - ì˜ˆì‹œ: "11ì‹œ ê¸°ìƒ" â†’ ì²« ë²ˆì§¸ ë°©ë¬¸(arrival)ì€ 11:00 ì´í›„ì—¬ì•¼ í•¨
  - ì˜ˆì‹œ: "ì €ë… 8ì‹œ ì „ì— ìˆ™ì†Œ ë³µê·€" â†’ ë§ˆì§€ë§‰ ë°©ë¬¸ì˜ departureê°€ 20:00 ì´ì „
  - ì ìš©: arrival/departure ì‹œê°„ì„ ê·œì¹™ì— ë§ê²Œ ì¡°ì •

- **í™œë™ ìš”êµ¬ ê·œì¹™**:
  - ì˜ˆì‹œ: "ì ì‹¬ì€ í˜„ì§€ ë§›ì§‘ì—ì„œ" â†’ ì ì‹¬ì‹œê°„(12:00-14:00)ì— RESTAURANT íƒ€ì… ì¥ì†Œ ë°©ë¬¸
  - ì˜ˆì‹œ: "ì¹´í˜ì—ì„œ ì—¬ìœ ë¡­ê²Œ" â†’ CAFE íƒ€ì… ì¥ì†Œë¥¼ ì¼ì •ì— í¬í•¨í•˜ê³  ì¶©ë¶„í•œ ì²´ë¥˜ì‹œê°„ í• ë‹¹
  - ì ìš©: ì ì ˆí•œ place_tagì˜ ì¥ì†Œë¥¼ í•´ë‹¹ ì‹œê°„ëŒ€ì— ë°°ì¹˜

- **ì¥ì†Œ/ì¼ì • ìš°ì„ ìˆœìœ„ ê·œì¹™**:
  - ì˜ˆì‹œ: "ë°•ë¬¼ê´€ ìš°ì„ " â†’ MUSEUM íƒ€ì… ì¥ì†Œë¥¼ ë‹¤ë¥¸ ê´€ê´‘ì§€ë³´ë‹¤ ë¨¼ì € ë°°ì¹˜
  - ì˜ˆì‹œ: "ë‘˜ì§¸ë‚ ì€ ìœ ë‹ˆë²„ì„¤ í•˜ë£¨ ì¢…ì¼" â†’ Day 2ëŠ” ìœ ë‹ˆë²„ì„¤ ìŠ¤íŠœë””ì˜¤ë§Œ í¬í•¨ (ë‹¤ë¥¸ ê´€ê´‘ì§€ ì œì™¸)
  - ì ìš©: í•´ë‹¹ ì¥ì†Œë¥¼ ì§€ì •ëœ ë‚ ì§œ/ì‹œê°„ì— ë°°ì¹˜í•˜ê³  ë‹¤ë¥¸ ê³„íš ì¡°ì •

- **ì´ë™/êµí†µ ì œì•½ ê·œì¹™**:
  - ì˜ˆì‹œ: "ë§ˆì§€ë§‰ë‚  ê³µí•­ìœ¼ë¡œ ì§í–‰" â†’ ë§ˆì§€ë§‰ë‚ ì€ ìˆ™ì†Œ ë³µê·€ ëŒ€ì‹  ê³µí•­ìœ¼ë¡œ ì¢…ë£Œ
  - ì˜ˆì‹œ: "ëŒ€ì¤‘êµí†µ ì´ìš©" â†’ travel_modeë¥¼ TRANSITìœ¼ë¡œ ì„¤ì •
  - ì ìš©: ì´ë™ ê²½ë¡œì™€ êµí†µìˆ˜ë‹¨ì„ ê·œì¹™ì— ë§ê²Œ ì¡°ì •

**ê·œì¹™ ì¶©ëŒ í•´ê²°**:
- ì—¬ëŸ¬ ê·œì¹™ì´ ì„œë¡œ ì¶©ëŒí•˜ëŠ” ê²½ìš° ë¨¼ì € ë‚˜ì˜¨ ê·œì¹™ì„ ìš°ì„  ì ìš©í•˜ì„¸ìš”
- ë‹¨, ì‚¬ìš©ìì˜ ì•ˆì „ê³¼ í¸ì˜ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•˜ì„¸ìš”
- ì¶©ëŒ ì˜ˆì‹œ: "11ì‹œ ê¸°ìƒ" + "ì•„ì¹¨ ì¼ì° ì‹œì¥ ë°©ë¬¸" â†’ 11ì‹œ ì´í›„ ì‹œì¥ ë°©ë¬¸ìœ¼ë¡œ ì¡°ì •

### 9. ğŸŸ  ìš´ì˜ì‹œê°„ ì¤€ìˆ˜ (ìµœëŒ€í•œ ê¶Œì¥ - Priority 2)

**ì ˆëŒ€ ê·œì¹™**:
1. Google Mapsì—ì„œ ê° ì¥ì†Œì˜ ìš´ì˜ì‹œê°„ì„ ë°˜ë“œì‹œ í™•ì¸í•˜ì„¸ìš”
2. ë°©ë¬¸ ì‹œê°„(arrival)ì€ ë°˜ë“œì‹œ ìš´ì˜ ì‹œì‘ ì‹œê°„ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤
3. ì¶œë°œ ì‹œê°„(departure)ì€ ë°˜ë“œì‹œ ìš´ì˜ ì¢…ë£Œ ì‹œê°„ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤
4. ì´ë™ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ë‹¤ìŒ ì¥ì†Œ ë„ì°©ì´ ìš´ì˜ì‹œê°„ ë‚´ê°€ ë˜ë„ë¡ í•˜ì„¸ìš”
5. íœ´ë¬´ì¼(closed)ì¸ ì¥ì†ŒëŠ” ì ˆëŒ€ ë°©ë¬¸í•˜ì§€ ë§ˆì„¸ìš”
6. ìš´ì˜ì‹œê°„ ì •ë³´ê°€ ì—†ëŠ” ì¥ì†ŒëŠ” ì¼ë°˜ì ì¸ ì˜ì—…ì‹œê°„(10:00-18:00)ì„ ê°€ì •í•˜ì„¸ìš”

**ìš”ì¼ë³„ ìš´ì˜ì‹œê°„ í™•ì¸**:
ì—¬í–‰ ì¼ì •ì˜ ê° ë‚ ì§œì™€ ìš”ì¼ ì •ë³´ëŠ” ìƒë‹¨ì˜ "ì—¬í–‰ ê¸°ê°„" ì„¹ì…˜ì— ëª…ì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤.
- ì˜ˆ: "Day 1: 2025-10-15 (ìˆ˜ìš”ì¼)"ì´ë©´ í•´ë‹¹ ë‚ ì§œëŠ” ìˆ˜ìš”ì¼ì…ë‹ˆë‹¤
- **ì¤‘ìš”**: Google Mapsì—ì„œ ê° ì¥ì†Œì˜ í•´ë‹¹ ìš”ì¼ ìš´ì˜ì‹œê°„ì„ í™•ì¸í•˜ì„¸ìš”
  - Day 1ì´ ìˆ˜ìš”ì¼ì´ë©´ Wednesday ìš´ì˜ì‹œê°„ ì‚¬ìš©
  - Day 2ê°€ ëª©ìš”ì¼ì´ë©´ Thursday ìš´ì˜ì‹œê°„ ì‚¬ìš©
- í•´ë‹¹ ìš”ì¼ì— íœ´ë¬´(closed)ì´ë©´ ê·¸ ë‚ ì§œì—ëŠ” ì ˆëŒ€ ë°©ë¬¸í•˜ì§€ ë§ˆì„¸ìš”

**ê²€ì¦ ë°©ë²•**:
- ê° ë°©ë¬¸ë§ˆë‹¤: `arrival â‰¥ opening_time` AND `departure â‰¤ closing_time`
- ì´ë™ ê³ ë ¤: `previous.departure + travel_time = current.arrival`

**ì˜ˆì‹œ**:
- ë°•ë¬¼ê´€ì´ ì›”ìš”ì¼ íœ´ë¬´ â†’ ì›”ìš”ì¼ì—ëŠ” ì¼ì •ì— í¬í•¨í•˜ì§€ ì•ŠìŒ
- í…Œë§ˆíŒŒí¬ ìš´ì˜ì‹œê°„ 09:00-21:00 â†’ arrivalì€ 09:00 ì´í›„, departureëŠ” 21:00 ì´ì „
- ë ˆìŠ¤í† ë‘ ì˜ì—…ì‹œê°„ 11:30-22:00 â†’ ì ì‹¬ ë°©ë¬¸ ì‹œ arrivalì€ 11:30 ì´í›„
- Day 1ì´ ì¼ìš”ì¼ì´ê³  íŠ¹ì • ìƒì ì´ ì¼ìš”ì¼ íœ´ë¬´ â†’ Day 1ì— í•´ë‹¹ ìƒì ì„ í¬í•¨í•˜ì§€ ì•ŠìŒ

### 10. ğŸŸ¡ ì²´ë¥˜ì‹œê°„ ê³ ë ¤ (Priority 3 - ìµœì í™”)
- ê° ì¥ì†Œë³„ ì ì ˆí•œ ì²´ë¥˜ì‹œê°„ì„ ê³ ë ¤í•˜ì„¸ìš”:
  - ëŒ€í˜• í…Œë§ˆíŒŒí¬ (ìœ ë‹ˆë²„ì„¤ ìŠ¤íŠœë””ì˜¤ ë“±): 6-10ì‹œê°„
  - ì£¼ìš” ê´€ê´‘ì§€ (ì„±, ì‚¬ì› ë“±): 1.5-3ì‹œê°„
  - ìˆ˜ì¡±ê´€/ë°•ë¬¼ê´€: 2-3ì‹œê°„
  - ì‡¼í•‘ ê±°ë¦¬: 1-2ì‹œê°„
  - ì‹ì‚¬: 1-1.5ì‹œê°„
  - ì¹´í˜/íœ´ì‹: 0.5-1ì‹œê°„

### 11. ğŸŸ¡ ì˜ˆì‚° ê³„ì‚° (Priority 3 - ìµœì í™”)
- 1ì¸ë‹¹ ì „ì²´ ì—¬í–‰ ì˜ˆì‚°ì„ ê³„ì‚°í•˜ì„¸ìš”
- í¬í•¨ í•­ëª©:
  - ìˆ™ì†Œ ë¹„ìš©: 1ë°•ë‹¹ í‰ê·  ê°€ê²© Ã— ìˆ™ë°• ì¼ìˆ˜ (ì˜ˆ: ì¤‘ê¸‰ í˜¸í…” ê¸°ì¤€ 1ë°• 80,000ì›)
  - êµí†µ ë¹„ìš©: ê³µí•­ ì´ë™ + ì‹œë‚´ êµí†µ (ì˜ˆ: ê³µí•­ ì™•ë³µ 30,000ì›, ì‹œë‚´ êµí†µ 1ì¼ 10,000ì›)
  - ì‹ì‚¬ ë¹„ìš©: 1ì¼ 3ì‹ Ã— ì—¬í–‰ ì¼ìˆ˜ (ì˜ˆ: ì•„ì¹¨ 8,000ì›, ì ì‹¬ 15,000ì›, ì €ë… 20,000ì›)
  - ì…ì¥ë£Œ: í…Œë§ˆíŒŒí¬, ë°•ë¬¼ê´€, ê´€ê´‘ì§€ ì…ì¥ë£Œ í•©ê³„
  - ê¸°íƒ€ ë¹„ìš©: ì‡¼í•‘, ê°„ì‹, ê¸°ë…í’ˆ ë“± (1ì¼ ì•½ 30,000ì›)
- ì›í™”(KRW) ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ì„¸ìš”
- í•©ë¦¬ì ì¸ ì¤‘ê°„ ê°€ê²©ëŒ€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‚°ì •í•˜ì„¸ìš”
- í™˜ìœ¨ ê³ ë ¤: í•´ì™¸ ì—¬í–‰ì¸ ê²½ìš° í˜„ì§€ í™”íë¥¼ ì›í™”ë¡œ í™˜ì‚°í•˜ì„¸ìš”

## ì¶œë ¥ í˜•ì‹

**ì¤‘ìš”**: ë‹¤ìŒ JSON êµ¬ì¡°ë¥¼ ì •í™•íˆ ë”°ë¥´ì„¸ìš”. budgetì€ itinerary ë°°ì—´ ë°–ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤!

```json
{{
  "itinerary": [
    {{
      "day": 1,
      "visits": [
        {{
          "order": 1,
          "display_name": "ì˜¤ì‚¬ì¹´ ì„±",
          "name_address": "ì˜¤ì‚¬ì¹´ ì„± 1-1 Osakajo, Chuo Ward, Osaka, 540-0002 ì¼ë³¸",
          "place_tag": "TOURIST_SPOT",
          "latitude": 34.6873,
          "longitude": 135.5262,
          "arrival": "09:00",
          "departure": "11:30",
          "travel_time": 30
        }},
        {{
          "order": 2,
          "display_name": "ë„í†¤ë³´ë¦¬",
          "name_address": "ë„í†¤ë³´ë¦¬ Dotonbori, Chuo Ward, Osaka, 542-0071 ì¼ë³¸",
          "place_tag": "TOURIST_SPOT",
          "latitude": 34.6687,
          "longitude": 135.5013,
          "arrival": "12:00",
          "departure": "14:00",
          "travel_time": 0
        }}
      ]
    }},
    {{
      "day": 2,
      "visits": [...]
    }}
  ],
  "budget": 500000
}}
```

**JSON êµ¬ì¡° ì£¼ì˜ì‚¬í•­**:
- ìµœìƒìœ„ ê°ì²´ì—ëŠ” ë‘ ê°œì˜ í•„ë“œë§Œ ìˆìŠµë‹ˆë‹¤: "itinerary"ì™€ "budget"
- "itinerary"ëŠ” ë°°ì—´ì´ë©°, ê° ìš”ì†ŒëŠ” day ê°ì²´ì…ë‹ˆë‹¤
- "budget"ì€ "itinerary" ë°°ì—´ì´ ë‹«íŒ í›„ ê°ì²´ì˜ ì†ì„±ìœ¼ë¡œ ì™€ì•¼ í•©ë‹ˆë‹¤ (ë°°ì—´ ì•ˆì— ë“¤ì–´ê°€ë©´ ì•ˆ ë©ë‹ˆë‹¤)

### ì¤‘ìš” ì‚¬í•­:
- **order**: ê° day ë‚´ì—ì„œ 1ë¶€í„° ì‹œì‘í•˜ëŠ” ë°©ë¬¸ ìˆœì„œ
- **display_name**: í‘œì‹œìš© ì¥ì†Œëª…ë§Œ (ì£¼ì†Œ ì œì™¸)
  - í˜•ì‹: "ì¥ì†Œëª…"
  - ì˜ˆì‹œ: "ì˜¤ì‚¬ì¹´ ì„±", "ìœ ë‹ˆë²„ì„¤ ìŠ¤íŠœë””ì˜¤ ì¬íŒ¬", "ë„í†¤ë³´ë¦¬"
  - ê°„ê²°í•˜ê³  ëª…í™•í•œ ì´ë¦„ ì‚¬ìš©
- **name_address**: ì¥ì†Œëª… + í•œì¹¸ ê³µë°± + ìƒì„¸ ì£¼ì†Œ
  - í˜•ì‹: "ì¥ì†Œëª… ì£¼ì†Œ"
  - ì˜ˆì‹œ: "ìœ ë‹ˆë²„ì„¤ ìŠ¤íŠœë””ì˜¤ ì¬íŒ¬ 2 Chome-1-33 Sakurajima, Konohana Ward, Osaka, 554-0031 ì¼ë³¸"
  - ì˜ˆì‹œ: "ì˜¤ì‚¬ì¹´ ì„± 1-1 Osakajo, Chuo Ward, Osaka, 540-0002 ì¼ë³¸"
  - **ë°˜ë“œì‹œ ì¥ì†Œëª…ê³¼ ì£¼ì†Œ ì‚¬ì´ì— í•œì¹¸ ê³µë°±ì„ ë„£ìœ¼ì„¸ìš”**
- **place_tag**: ì¥ì†Œ ìœ í˜• íƒœê·¸ (ë¬¸ìì—´, ëŒ€ë¬¸ì)
  - ê°€ëŠ¥í•œ ê°’: "TOURIST_SPOT", "HOME", "RESTAURANT", "CAFE", "OTHER"
  - í• ë‹¹ ê·œì¹™:
    - **TOURIST_SPOT**: ê´€ê´‘ì§€, ë°•ë¬¼ê´€, í…Œë§ˆíŒŒí¬, ì‚¬ì›, ì„±, ì „ë§ëŒ€ ë“±
    - **HOME**: í˜¸í…”, ê²ŒìŠ¤íŠ¸í•˜ìš°ìŠ¤, ìˆ™ì†Œ, ë¦¬ì¡°íŠ¸ ë“±
    - **RESTAURANT**: ì‹ë‹¹, ë ˆìŠ¤í† ë‘, ìŒì‹ì , ì‹œì¥ (ìŒì‹ ì¤‘ì‹¬) ë“±
    - **CAFE**: ì¹´í˜, ë””ì €íŠ¸ ê°€ê²Œ, ë² ì´ì»¤ë¦¬ ë“±
    - **OTHER**: ìœ„ ë¶„ë¥˜ì— ë§ì§€ ì•ŠëŠ” ê²½ìš° (ê³µí•­, ì—­ ë“±)
  - Geminiê°€ ìƒˆë¡œ ì¶”ì²œí•˜ëŠ” ì¥ì†ŒëŠ” ê°€ì¥ ì ì ˆí•œ íƒœê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”
- **latitude, longitude**: ì†Œìˆ˜ì  í˜•ì‹ì˜ ì •í™•í•œ ì¢Œí‘œ
- **arrival**: í•´ë‹¹ ì¥ì†Œì— ë„ì°©í•˜ëŠ” ì‹œê°„ (24ì‹œê°„ í˜•ì‹ "HH:MM", ì˜ˆ: "09:00", "14:30")
  - ì²« ë²ˆì§¸ visit: í•˜ë£¨ ì¼ì • ì‹œì‘ ì‹œê°„ (ì˜ˆ: 09:00)
  - ì´í›„ visit: ì´ì „ ì¥ì†Œì˜ departure + travel_timeìœ¼ë¡œ ê³„ì‚°
- **departure**: í•´ë‹¹ ì¥ì†Œì—ì„œ ë– ë‚˜ëŠ” ì‹œê°„ (24ì‹œê°„ í˜•ì‹ "HH:MM")
  - arrival + í•´ë‹¹ ì¥ì†Œ ì²´ë¥˜ì‹œê°„ìœ¼ë¡œ ê³„ì‚°
  - ì²´ë¥˜ì‹œê°„ì€ ì„¹ì…˜ 10ì˜ ê°€ì´ë“œë¼ì¸ì„ ì°¸ê³ í•˜ì„¸ìš”
  - ì˜ˆ: ì˜¤ì‚¬ì¹´ ì„± arrival "09:00" â†’ 2.5ì‹œê°„ ì²´ë¥˜ â†’ departure "11:30"
- **travel_time**: ë‹¤ìŒ ì¥ì†Œë¡œ ê°€ëŠ” ì´ë™ì‹œê°„ (ë¶„ ë‹¨ìœ„ ì •ìˆ˜), ë§ˆì§€ë§‰ visitëŠ” 0
  - í˜„ì¬ ì¥ì†Œì˜ departureë¶€í„° ë‹¤ìŒ ì¥ì†Œì˜ arrivalê¹Œì§€ ì†Œìš”ë˜ëŠ” ì‹œê°„
  - ì˜ˆ: í˜„ì¬ ì¥ì†Œ departure "11:30", travel_time 30ë¶„ â†’ ë‹¤ìŒ ì¥ì†Œ arrival "12:00"
- **budget**: 1ì¸ë‹¹ ì˜ˆìƒ ì˜ˆì‚° (ì •ìˆ˜, ì›í™” ê¸°ì¤€)
  - ìˆ™ì†Œ, êµí†µ, ì‹ì‚¬, ì…ì¥ë£Œ, ê¸°íƒ€ ë¹„ìš©ì„ ëª¨ë‘ í¬í•¨í•œ ì´ ì˜ˆì‚°
  - ì˜ˆì‹œ: 2ë°• 3ì¼ ì˜¤ì‚¬ì¹´ ì—¬í–‰ = ì•½ 500,000ì› (ì¤‘ê¸‰ í˜¸í…”, ëŒ€ì¤‘êµí†µ ì´ìš© ê¸°ì¤€)

## í•„ìˆ˜ ì¤€ìˆ˜ ì‚¬í•­
- **ìˆœìˆ˜ JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”. ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(```)ì´ë‚˜ ì„¤ëª… í…ìŠ¤íŠ¸ ì—†ì´ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.**
- **JSON êµ¬ì¡°ë¥¼ ì •í™•íˆ ì§€í‚¤ì„¸ìš”**: ìµœìƒìœ„ëŠ” ê°ì²´ì´ë©°, "itinerary" ë°°ì—´ê³¼ "budget" ìˆ«ì ë‘ ê°œì˜ ì†ì„±ë§Œ ê°€ì§‘ë‹ˆë‹¤
- **budgetì€ itinerary ë°°ì—´ ë°–ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤** - ë°°ì—´ ì•ˆì— ë„£ì§€ ë§ˆì„¸ìš”
- **ìœ íš¨í•œ JSON í˜•ì‹**: ì‰¼í‘œ, ì¤‘ê´„í˜¸, ëŒ€ê´„í˜¸ë¥¼ ì •í™•íˆ ì‚¬ìš©í•˜ì„¸ìš”
"""

        return prompt

    def _infer_location_from_country(self, country: str) -> Dict[str, float]:
        """
        country í…ìŠ¤íŠ¸ì—ì„œ ì¤‘ì‹¬ ì¢Œí‘œ ì¶”ë¡ 

        Args:
            country: ì—¬í–‰ êµ­ê°€/ë„ì‹œ í…ìŠ¤íŠ¸ (ì˜ˆ: "ì¼ë³¸, ì˜¤ì‚¬ì¹´", "ë„ì¿„")

        Returns:
            Dict[str, float]: latitude, longitudeë¥¼ í¬í•¨í•œ ë”•ì…”ë„ˆë¦¬

        Note:
            ê°„ë‹¨í•œ ë§¤í•‘ í…Œì´ë¸” ì‚¬ìš©. ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ (0.0, 0.0) ë°˜í™˜
            (Geminiê°€ í…ìŠ¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ì¶”ë¡ )
        """
        location_map = {
            "ì˜¤ì‚¬ì¹´": {"latitude": 34.6937, "longitude": 135.5023},
            "osaka": {"latitude": 34.6937, "longitude": 135.5023},
            "ë„ì¿„": {"latitude": 35.6762, "longitude": 139.6503},
            "tokyo": {"latitude": 35.6762, "longitude": 139.6503},
            "êµí† ": {"latitude": 35.0116, "longitude": 135.7681},
            "kyoto": {"latitude": 35.0116, "longitude": 135.7681},
            "í›„ì¿ ì˜¤ì¹´": {"latitude": 33.5904, "longitude": 130.4017},
            "fukuoka": {"latitude": 33.5904, "longitude": 130.4017},
            "ì„œìš¸": {"latitude": 37.5665, "longitude": 126.9780},
            "seoul": {"latitude": 37.5665, "longitude": 126.9780},
            "ë¶€ì‚°": {"latitude": 35.1796, "longitude": 129.0756},
            "busan": {"latitude": 35.1796, "longitude": 129.0756},
            "ì œì£¼": {"latitude": 33.4996, "longitude": 126.5312},
            "jeju": {"latitude": 33.4996, "longitude": 126.5312},
        }

        country_lower = country.lower()
        for key, coords in location_map.items():
            if key in country_lower:
                logger.info(f"Location center inferred: {country} â†’ ({coords['latitude']}, {coords['longitude']})")
                return coords

        # ê¸°ë³¸ê°’ (Geminiê°€ í…ìŠ¤íŠ¸ ê¸°ë°˜ ì¶”ë¡ )
        logger.warning(f"Location not found in map, using default (0.0, 0.0): {country}")
        return {"latitude": 0.0, "longitude": 0.0}

    async def generate_itinerary(
        self,
        request: ItineraryRequest2,
    ) -> ItineraryResponse2:
        """
        V2 ì¼ì • ìƒì„± ë©”ì¸ í•¨ìˆ˜

        Args:
            request: ì¼ì • ìƒì„± ìš”ì²­ (ì¥ì†Œ, ì±„íŒ… ë‚´ìš© ë“± í¬í•¨)

        Returns:
            ItineraryResponse2: ìƒì„±ëœ ì—¬í–‰ ì¼ì •

        Raises:
            Exception: Gemini API í˜¸ì¶œ ì‹¤íŒ¨ ë˜ëŠ” JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ

        Note:
            V1ê³¼ ë‹¬ë¦¬ DB ì¡°íšŒ, í´ëŸ¬ìŠ¤í„°ë§, ì´ë™ì‹œê°„ ë§¤íŠ¸ë¦­ìŠ¤ ê³„ì‚° ì—†ìŒ
            ëª¨ë“  ë¡œì§ì„ Geminiì—ê²Œ ìœ„ì„
        """
        try:
            # í”„ë¡¬í”„íŠ¸ ìƒì„±
            prompt = self._create_prompt_v2(request)

            # ìœ„ì¹˜ ê¸°ì¤€ì  ì¶”ë¡ 
            center_coords = self._infer_location_from_country(request.country)

            logger.info(
                f"Generating V2 itinerary: {len(request.places)} places, "
                f"{request.days} days, {len(request.chat)} chat messages, "
                f"{request.members} members, country: {request.country}"
            )
            logger.info(f"Location center: ({center_coords['latitude']}, {center_coords['longitude']})")
            logger.debug(f"Prompt length: {len(prompt)} characters")

            # Gemini API í˜¸ì¶œ (Google Maps Grounding í™œì„±í™”)
            logger.info("Calling Gemini API with Google Maps grounding...")
            response = self.client.models.generate_content(
                model=self.model_name,
                contents=prompt,
                config=types.GenerateContentConfig(
                    temperature=0.7,
                    # Note: response_mime_type="application/json" is not supported with Google Maps tool
                    tools=[
                        types.Tool(google_maps=types.GoogleMaps())  # âœ… Google Maps Grounding Tool
                    ],
                    tool_config=types.ToolConfig(
                        retrieval_config=types.RetrievalConfig(
                            lat_lng=types.LatLng(
                                latitude=center_coords["latitude"],
                                longitude=center_coords["longitude"]
                            )
                        )
                    )
                ),
            )

            # ì‘ë‹µ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            response_text = response.text
            logger.info(f"Received response: {len(response_text)} characters")
            logger.debug(f"Response preview: {response_text[:200]}...")

            # ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±° (Google Maps tool ì‚¬ìš© ì‹œ response_mime_type ë¯¸ì§€ì›)
            if response_text.startswith("```json"):
                response_text = response_text.replace("```json\n", "").replace("```", "").strip()
                logger.info("Removed markdown code block from response")
            elif response_text.startswith("```"):
                response_text = response_text.replace("```\n", "").replace("```", "").strip()
                logger.info("Removed markdown code block from response")

            # JSON íŒŒì‹±
            try:
                itinerary_data = json.loads(response_text)
            except json.JSONDecodeError as e:
                logger.error(f"JSON parse error: {str(e)}")
                logger.error(f"Full response text:\n{response_text}")

                # ì—ëŸ¬ ìœ„ì¹˜ ì£¼ë³€ í…ìŠ¤íŠ¸ í‘œì‹œ (ë””ë²„ê¹…ìš©)
                error_pos = e.pos
                start = max(0, error_pos - 100)
                end = min(len(response_text), error_pos + 100)
                logger.error(f"Error context (pos {error_pos}):\n...{response_text[start:end]}...")

                raise Exception(f"Gemini returned invalid JSON: {str(e)}")

            # Pydantic ê²€ì¦
            try:
                itinerary_response = ItineraryResponse2(**itinerary_data)
            except Exception as e:
                logger.error(f"Pydantic validation error: {str(e)}")
                logger.error(f"Data: {json.dumps(itinerary_data, indent=2, ensure_ascii=False)}")
                raise Exception(f"Invalid itinerary format: {str(e)}")

            # ì„±ê³µ ë¡œê·¸
            total_visits = sum(len(day.visits) for day in itinerary_response.itinerary)
            logger.info(
                f"Successfully generated V2 itinerary: "
                f"{len(itinerary_response.itinerary)} days, {total_visits} total visits"
            )

            # ê° ì¼ì°¨ë³„ ìš”ì•½ ë¡œê·¸
            for day in itinerary_response.itinerary:
                visit_names = [v.display_name for v in day.visits]
                logger.info(f"  Day {day.day}: {len(day.visits)} visits - {', '.join(visit_names)}")

            return itinerary_response

        except Exception as e:
            logger.error(f"V2 itinerary generation failed: {str(e)}", exc_info=True)
            raise


# ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤
itinerary_generator_service2 = ItineraryGeneratorService2()
